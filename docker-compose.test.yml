version: '3.8'

# Docker Compose for Integration Testing
# Minimal configuration optimized for test execution
# Services: PostgreSQL, Redis, RabbitMQ with health checks

services:
  # =============================================
  # PostgreSQL Database - Test Instance
  # =============================================
  postgres:
    image: postgres:15-alpine
    container_name: test_postgres
    restart: no
    environment:
      POSTGRES_DB: test_agent_orchestrator
      POSTGRES_USER: testuser
      POSTGRES_PASSWORD: testpass123
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.utf8"
    ports:
      - "5432:5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U testuser -d test_agent_orchestrator"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - test_network
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # =============================================
  # Redis Cache - Test Instance
  # =============================================
  redis:
    image: redis:7-alpine
    container_name: test_redis
    restart: no
    command: >
      redis-server
      --appendonly no
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --requirepass testpass123
    ports:
      - "6379:6379"
    volumes:
      - redis_test_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - test_network
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # =============================================
  # RabbitMQ Message Broker - Test Instance
  # =============================================
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: test_rabbitmq
    restart: no
    environment:
      RABBITMQ_DEFAULT_USER: testuser
      RABBITMQ_DEFAULT_PASS: testpass123
      RABBITMQ_DEFAULT_VHOST: /
      RABBITMQ_HEARTBEAT: 30
      RABBITMQ_CHANNEL_MAX: 2048
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq_test_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - test_network
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# =============================================
# Networks
# =============================================
networks:
  test_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16

# =============================================
# Volumes
# =============================================
volumes:
  postgres_test_data:
    driver: local
  redis_test_data:
    driver: local
  rabbitmq_test_data:
    driver: local
