version: '3.8'

# Enterprise Jaeger Stack for Distributed Tracing
# Includes: Jaeger Agent, Collector, Query (UI), and Elasticsearch storage

services:
  # ============ JAEGER COMPONENTS ============

  # Jaeger Agent - Receives spans from applications via UDP
  jaeger-agent:
    image: jaegertracing/jaeger:latest
    container_name: jaeger-agent
    restart: unless-stopped
    command: jaeger-agent
    environment:
      - COLLECTOR_ZIPKIN_HOST_PORT=jaeger-collector:9411
      - COLLECTOR_GRPC_HOST_PORT=jaeger-collector:14250
      - REPORTER_GRPC_HOST_PORT=jaeger-collector:14250
      - REPORTER_LOG_SPANS=false
      - AGENT_SERVER_QUEUE_SIZE=2000
      - AGENT_MAX_PACKET_SIZE=65000
    ports:
      # Jaeger agent ports
      - "6831:6831/udp"   # Jaeger compact thrift protocol (UDP)
      - "6832:6832/udp"   # Jaeger binary thrift protocol (UDP)
      - "5775:5775/udp"   # Zipkin compact thrift protocol (UDP)
      - "5778:5778/tcp"   # Agent HTTP serving frontend
      # Reporting ports (gRPC)
      - "14250:14250"     # gRPC server for receiving spans from Collector
    networks:
      - tracing
    depends_on:
      jaeger-collector:
        condition: service_started

  # Jaeger Collector - Receives spans from agents/SDKs and stores them
  jaeger-collector:
    image: jaegertracing/jaeger:latest
    container_name: jaeger-collector
    restart: unless-stopped
    command: jaeger-collector
    environment:
      - SPAN_STORAGE_TYPE=elasticsearch
      - ES_SERVER_URLS=http://elasticsearch-jaeger:9200
      - ES_INDEX_PREFIX=jaeger
      - ES_BULK_SIZE=2000
      - ES_BULK_ACTIONS=1000
      - ES_BULK_FLUSH_INTERVAL=200ms
      - ES_USE_ALIASES=false
      - ES_CREATE_INDEX_AS_ALIAS=false
      - COLLECTOR_ZIPKIN_HTTP_PORT=9411
      - COLLECTOR_GRPC_PORT=14250
      - COLLECTOR_HTTP_PORT=14268
      - COLLECTOR_OTLP_ENABLED=true
      - COLLECTOR_OTLP_GRPC_ENABLED=true
      - COLLECTOR_QUEUE_SIZE=2000
      - COLLECTOR_NUM_WORKERS=10
      - COLLECTOR_HTTP_SERVER_HOST_PORT=:14268
    ports:
      # Collector ports
      - "14268:14268"  # HTTP collector API
      - "14250:14250"  # gRPC collector API
      - "9411:9411"    # Zipkin API
      - "14267:14267"  # Admin port
    networks:
      - tracing
      - elk
    depends_on:
      elasticsearch-jaeger:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:14268/ || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # Jaeger Query - Provides UI and query API for spans
  jaeger-query:
    image: jaegertracing/jaeger:latest
    container_name: jaeger-query
    restart: unless-stopped
    command: jaeger-query
    environment:
      - SPAN_STORAGE_TYPE=elasticsearch
      - ES_SERVER_URLS=http://elasticsearch-jaeger:9200
      - ES_INDEX_PREFIX=jaeger
      - ES_USE_ALIASES=false
      - QUERY_BASE_PATH=/jaeger
      - QUERY_PORT=16686
      - QUERY_STATIC_FILES=/usr/share/jaeger/console
      - QUERY_MAX_CLOCK_SKEW_ADJUSTMENT=1s
      - QUERY_ENABLED_ARCHIVES=true
    ports:
      - "16686:16686"  # Jaeger UI and query API
      - "16687:16687"  # Admin port
    networks:
      - tracing
      - elk
    depends_on:
      - elasticsearch-jaeger
    healthcheck:
      test: curl -f http://localhost:16686/ || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # ============ JAEGER DEPENDENCIES ============

  # Elasticsearch for Jaeger storage
  elasticsearch-jaeger:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch-jaeger
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - bootstrap.memory_lock=true
    volumes:
      - elasticsearch-jaeger-data:/usr/share/elasticsearch/data
    ports:
      - "9203:9200"  # Separate port to avoid conflict with main ELK stack
    networks:
      - tracing
      - elk
    healthcheck:
      test: curl -s http://localhost:9200 >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    ulimits:
      memlock:
        soft: -1
        hard: -1

  # ============ SPAN INDEX MANAGEMENT ============

  # Index Configuration Service
  jaeger-index-configurator:
    image: curlimages/curl:latest
    container_name: jaeger-index-configurator
    restart: "no"
    networks:
      - tracing
      - elk
    depends_on:
      elasticsearch-jaeger:
        condition: service_healthy
    command: >
      sh -c '
      sleep 30 &&
      echo "Configuring Jaeger Index Lifecycle Management..." &&
      curl -X PUT "http://elasticsearch-jaeger:9200/_ilm/policy/jaeger-trace-policy" \
        -H "Content-Type: application/json" \
        -d "{
          \"policy\": \"jaeger-trace-policy\",
          \"phases\": {
            \"hot\": {
              \"min_age\": \"0d\",
              \"actions\": {
                \"rollover\": {
                  \"max_primary_store_size\": \"50GB\",
                  \"max_age\": \"1d\"
                },
                \"set_priority\": {
                  \"priority\": 100
                }
              }
            },
            \"warm\": {
              \"min_age\": \"1d\",
              \"actions\": {
                \"set_priority\": {
                  \"priority\": 50
                },
                \"forcemerge\": {
                  \"max_num_segments\": 1
                }
              }
            },
            \"delete\": {
              \"min_age\": \"7d\",
              \"actions\": {
                \"delete\": {}
              }
            }
          }
        }" || true &&
      echo "Jaeger ILM policy configured"
      '

  # ============ MONITORING & OBSERVABILITY ============

  # Elasticsearch Exporter for Jaeger cluster
  elasticsearch-exporter-jaeger:
    image: prometheuscommunity/elasticsearch-exporter:latest
    container_name: elasticsearch-exporter-jaeger
    restart: unless-stopped
    command:
      - '--es.uri=http://elasticsearch-jaeger:9200'
      - '--es.all'
      - '--es.indices'
    ports:
      - "9115:9114"  # Different port to avoid conflict
    networks:
      - tracing
      - elk
    depends_on:
      - elasticsearch-jaeger

  # Jaeger Metrics (Prometheus compatible)
  # Jaeger services expose Prometheus metrics natively
  # Query them from: localhost:14269/metrics (Jaeger Agent)
  #                  localhost:14269/metrics (Jaeger Collector)
  #                  localhost:14269/metrics (Jaeger Query)

  # ============ JAEGER SAMPLING CONFIGURATION ============

  # Sampling Strategy Service (optional - for dynamic sampling)
  jaeger-sampling-config:
    image: curlimages/curl:latest
    container_name: jaeger-sampling-config
    restart: "no"
    networks:
      - tracing
    depends_on:
      jaeger-collector:
        condition: service_started
    command: >
      sh -c '
      sleep 20 &&
      echo "Configuring Jaeger sampling strategies..." &&
      curl -X POST "http://jaeger-collector:14268/sampling" \
        -H "Content-Type: application/json" \
        -d "{
          \"default_strategy\": {
            \"type\": \"probabilistic\",
            \"param\": 1.0
          },
          \"service_strategies\": [
            {
              \"service\": \"ai-agent-platform\",
              \"type\": \"probabilistic\",
              \"param\": 1.0
            },
            {
              \"service\": \"rabbitmq-processor\",
              \"type\": \"probabilistic\",
              \"param\": 1.0
            }
          ]
        }" || true &&
      echo "Sampling configured"
      '

  # ============ TRACE STORAGE RETENTION POLICY ============

  # Archive Retention Job (cleanup old traces)
  jaeger-cleanup:
    image: jaegertracing/jaeger:latest
    container_name: jaeger-cleanup
    restart: "no"
    command: /bin/sh -c 'sleep 3600 && curl -X DELETE http://elasticsearch-jaeger:9200/jaeger-span-*'
    networks:
      - tracing
      - elk
    depends_on:
      - elasticsearch-jaeger

networks:
  tracing:
    driver: bridge
    ipam:
      config:
        - subnet: 172.26.0.0/16

  elk:
    external: true
    name: elk

volumes:
  elasticsearch-jaeger-data:
    driver: local
