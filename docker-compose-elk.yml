version: '3.8'

# Enterprise ELK Stack (Elasticsearch, Logstash, Kibana)
# For centralized log aggregation, processing, and visualization

services:
  # ============ ELASTICSEARCH CLUSTER ============

  # Elasticsearch Node 1 (Master-eligible, Data)
  elasticsearch-1:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch-1
    restart: unless-stopped
    environment:
      - node.name=es-node-1
      - discovery.seed_hosts=elasticsearch-2,elasticsearch-3
      - cluster.initial_master_nodes=es-node-1,es-node-2,es-node-3
      - cluster.name=${ELASTICSEARCH_CLUSTER_NAME:-ai-agent-cluster}
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - "ES_JAVA_OPTS=${ES_JAVA_OPTS:--Xms2g -Xmx2g}"
      - bootstrap.memory_lock=true
      - indices.memory.index_buffer_size=40%
      - thread_pool.search.queue_size=5000
      - thread_pool.bulk.queue_size=5000
    volumes:
      - elasticsearch-1-data:/usr/share/elasticsearch/data
      - ./monitoring/elasticsearch/elasticsearch-1.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
    ports:
      - "9200:9200"  # REST API
      - "9300:9300"  # Node communication
    networks:
      - elk
    healthcheck:
      test: curl -s http://localhost:9200 >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65535
        hard: 65535

  # Elasticsearch Node 2 (Master-eligible, Data)
  elasticsearch-2:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch-2
    restart: unless-stopped
    environment:
      - node.name=es-node-2
      - discovery.seed_hosts=elasticsearch-1,elasticsearch-3
      - cluster.initial_master_nodes=es-node-1,es-node-2,es-node-3
      - cluster.name=${ELASTICSEARCH_CLUSTER_NAME:-ai-agent-cluster}
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - "ES_JAVA_OPTS=${ES_JAVA_OPTS:--Xms2g -Xmx2g}"
      - bootstrap.memory_lock=true
      - indices.memory.index_buffer_size=40%
      - thread_pool.search.queue_size=5000
      - thread_pool.bulk.queue_size=5000
    volumes:
      - elasticsearch-2-data:/usr/share/elasticsearch/data
      - ./monitoring/elasticsearch/elasticsearch-2.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
    ports:
      - "9201:9200"
      - "9301:9300"
    networks:
      - elk
    depends_on:
      - elasticsearch-1
    healthcheck:
      test: curl -s http://localhost:9200 >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65535
        hard: 65535

  # Elasticsearch Node 3 (Master-eligible, Data)
  elasticsearch-3:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch-3
    restart: unless-stopped
    environment:
      - node.name=es-node-3
      - discovery.seed_hosts=elasticsearch-1,elasticsearch-2
      - cluster.initial_master_nodes=es-node-1,es-node-2,es-node-3
      - cluster.name=${ELASTICSEARCH_CLUSTER_NAME:-ai-agent-cluster}
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - "ES_JAVA_OPTS=${ES_JAVA_OPTS:--Xms2g -Xmx2g}"
      - bootstrap.memory_lock=true
      - indices.memory.index_buffer_size=40%
      - thread_pool.search.queue_size=5000
      - thread_pool.bulk.queue_size=5000
    volumes:
      - elasticsearch-3-data:/usr/share/elasticsearch/data
      - ./monitoring/elasticsearch/elasticsearch-3.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
    ports:
      - "9202:9200"
      - "9302:9300"
    networks:
      - elk
    depends_on:
      - elasticsearch-1
    healthcheck:
      test: curl -s http://localhost:9200 >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65535
        hard: 65535

  # ============ LOGSTASH ============

  logstash:
    image: docker.elastic.co/logstash/logstash:8.11.0
    container_name: logstash
    restart: unless-stopped
    environment:
      - "LS_JAVA_OPTS=${LOGSTASH_JAVA_OPTS:--Xmx1g -Xms1g}"
      - "LOGSTASH_INTERNAL_VISIBILITY_API_PORT=9600"
      - "ELASTICSEARCH_HOSTS=http://elasticsearch-1:9200"
      - "ELASTICSEARCH_USER=${ELASTICSEARCH_USER:-elastic}"
      - "ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD:-changeme}"
    volumes:
      - ./monitoring/logstash/pipeline:/usr/share/logstash/pipeline:ro
      - ./monitoring/logstash/patterns:/usr/share/logstash/patterns:ro
      - logstash-data:/usr/share/logstash/data
    ports:
      - "5000:5000/tcp"    # TCP input for logs
      - "5000:5000/udp"    # UDP input for syslog
      - "5001:5001/tcp"    # JSON input
      - "9600:9600"        # Metrics API
    networks:
      - elk
    depends_on:
      elasticsearch-1:
        condition: service_healthy
    healthcheck:
      test: curl -s http://localhost:9600 >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # ============ KIBANA ============

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: kibana
    restart: unless-stopped
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch-1:9200
      - ELASTICSEARCH_USERNAME=${ELASTICSEARCH_USER:-elastic}
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD:-changeme}
      - KIBANA_DEFAULTAPPID=discover
      - SERVER_NAME=kibana
      - XPACK_SECURITY_ENABLED=false
      - XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY=${KIBANA_ENCRYPTION_KEY:-aaaaaaaaaaaaaaaabbbbbbbbbbbbbbbb}
    volumes:
      - ./monitoring/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
      - ./monitoring/kibana/dashboards:/usr/share/kibana/dashboards:ro
      - kibana-data:/usr/share/kibana/data
    ports:
      - "5601:5601"
    networks:
      - elk
    depends_on:
      elasticsearch-1:
        condition: service_healthy
    healthcheck:
      test: curl -s http://localhost:5601/api/status >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # ============ INDEX LIFECYCLE MANAGEMENT ============

  # ILM Configuration Service
  ilm-configurator:
    image: curlimages/curl:latest
    container_name: ilm-configurator
    restart: "no"
    networks:
      - elk
    depends_on:
      elasticsearch-1:
        condition: service_healthy
    command: >
      sh -c '
      sleep 30 &&
      echo "Configuring Index Lifecycle Management..." &&
      curl -X PUT "http://elasticsearch-1:9200/_ilm/policy/logs-policy" \
        -H "Content-Type: application/json" \
        -d @/tmp/ilm-policy.json || true &&
      echo "ILM Policy configured"
      '
    volumes:
      - ./monitoring/elasticsearch/ilm-policy.json:/tmp/ilm-policy.json:ro

  # ============ INDEX TEMPLATES ============

  # Template Configuration Service
  template-configurator:
    image: curlimages/curl:latest
    container_name: template-configurator
    restart: "no"
    networks:
      - elk
    depends_on:
      elasticsearch-1:
        condition: service_healthy
    command: >
      sh -c '
      sleep 35 &&
      echo "Configuring Index Templates..." &&
      curl -X PUT "http://elasticsearch-1:9200/_index_template/logs-template" \
        -H "Content-Type: application/json" \
        -d @/tmp/logs-template.json || true &&
      curl -X PUT "http://elasticsearch-1:9200/_index_template/traces-template" \
        -H "Content-Type: application/json" \
        -d @/tmp/traces-template.json || true &&
      echo "Templates configured"
      '
    volumes:
      - ./monitoring/elasticsearch/logs-template.json:/tmp/logs-template.json:ro
      - ./monitoring/elasticsearch/traces-template.json:/tmp/traces-template.json:ro

  # ============ DASHBOARDS PROVISIONING ============

  # Dashboard Configuration Service
  dashboard-configurator:
    image: curlimages/curl:latest
    container_name: dashboard-configurator
    restart: "no"
    networks:
      - elk
    depends_on:
      kibana:
        condition: service_healthy
    command: >
      sh -c '
      sleep 60 &&
      echo "Importing Kibana dashboards..." &&
      curl -X POST "http://kibana:5601/api/saved_objects/dashboard" \
        -H "Content-Type: application/json" \
        -H "kbn-xsrf: true" \
        -d @/tmp/dashboard-system-overview.json || true &&
      curl -X POST "http://kibana:5601/api/saved_objects/dashboard" \
        -H "Content-Type: application/json" \
        -H "kbn-xsrf: true" \
        -d @/tmp/dashboard-app-performance.json || true &&
      echo "Dashboards imported"
      '
    volumes:
      - ./monitoring/kibana/dashboards/dashboard-system-overview.json:/tmp/dashboard-system-overview.json:ro
      - ./monitoring/kibana/dashboards/dashboard-app-performance.json:/tmp/dashboard-app-performance.json:ro

  # ============ MONITORING & OBSERVABILITY ============

  # Elasticsearch Exporter (Prometheus integration)
  elasticsearch-exporter:
    image: prometheuscommunity/elasticsearch-exporter:latest
    container_name: elasticsearch-exporter
    restart: unless-stopped
    command:
      - '--es.uri=http://elasticsearch-1:9200'
      - '--es.all'
      - '--es.indices'
      - '--es.indices_settings'
      - '--es.shards'
      - '--es.snapshots'
    ports:
      - "9114:9114"
    networks:
      - elk
    depends_on:
      - elasticsearch-1

  # Logstash Exporter (Prometheus integration)
  logstash-exporter:
    image: prometheuscommunity/logstash-exporter:latest
    container_name: logstash-exporter
    restart: unless-stopped
    environment:
      - LOGSTASH_URL=http://logstash:9600
    ports:
      - "9304:9304"
    networks:
      - elk
    depends_on:
      - logstash

networks:
  elk:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

volumes:
  elasticsearch-1-data:
    driver: local
  elasticsearch-2-data:
    driver: local
  elasticsearch-3-data:
    driver: local
  logstash-data:
    driver: local
  kibana-data:
    driver: local
