version: '3.8'

# Complete Enterprise Observability Stack
# Integrates: Prometheus/Grafana + ELK + Jaeger + Elastic APM
# Provides unified monitoring, logging, tracing, and APM

services:
  # ============ ELASTICSEARCH CLUSTER (Shared) ============

  elasticsearch-main:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch-main
    restart: unless-stopped
    environment:
      - node.name=es-main
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - "ES_JAVA_OPTS=-Xms3g -Xmx3g"
      - bootstrap.memory_lock=true
      - cluster.name=observability-cluster
      - indices.memory.index_buffer_size=40%
      - thread_pool.search.queue_size=5000
      - thread_pool.bulk.queue_size=5000
    volumes:
      - elasticsearch-main-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - observability
    healthcheck:
      test: curl -s http://localhost:9200 >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    ulimits:
      memlock:
        soft: -1
        hard: -1

  # ============ LOG AGGREGATION LAYER ============

  # Logstash - Process, parse, and enrich logs
  logstash:
    image: docker.elastic.co/logstash/logstash:8.11.0
    container_name: logstash
    restart: unless-stopped
    environment:
      - "LS_JAVA_OPTS=-Xmx1g -Xms1g"
      - ELASTICSEARCH_HOSTS=http://elasticsearch-main:9200
      - ELASTICSEARCH_USER=elastic
      - ELASTICSEARCH_PASSWORD=changeme
    volumes:
      - ./monitoring/logstash/pipeline:/usr/share/logstash/pipeline:ro
      - ./monitoring/logstash/patterns:/usr/share/logstash/patterns:ro
      - logstash-data:/usr/share/logstash/data
    ports:
      - "5000:5000/tcp"    # TCP input
      - "5000:5000/udp"    # UDP/Syslog input
      - "5001:5001/tcp"    # JSON input
      - "9600:9600"        # Metrics
    networks:
      - observability
    depends_on:
      elasticsearch-main:
        condition: service_healthy
    healthcheck:
      test: curl -s http://localhost:9600 >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # ============ DISTRIBUTED TRACING LAYER ============

  # Jaeger Agent - Receives spans from apps
  jaeger-agent:
    image: jaegertracing/jaeger:latest
    container_name: jaeger-agent
    restart: unless-stopped
    command: jaeger-agent
    environment:
      - COLLECTOR_GRPC_HOST_PORT=jaeger-collector:14250
      - REPORTER_GRPC_HOST_PORT=jaeger-collector:14250
    ports:
      - "6831:6831/udp"   # Jaeger compact thrift
      - "6832:6832/udp"   # Jaeger binary thrift
      - "5775:5775/udp"   # Zipkin compact thrift
      - "5778:5778/tcp"   # Agent HTTP
      - "14250:14250"     # gRPC
    networks:
      - observability
    depends_on:
      - jaeger-collector

  # Jaeger Collector - Collects and stores spans
  jaeger-collector:
    image: jaegertracing/jaeger:latest
    container_name: jaeger-collector
    restart: unless-stopped
    command: jaeger-collector
    environment:
      - SPAN_STORAGE_TYPE=elasticsearch
      - ES_SERVER_URLS=http://elasticsearch-main:9200
      - ES_INDEX_PREFIX=jaeger
      - ES_BULK_SIZE=2000
      - COLLECTOR_ZIPKIN_HTTP_PORT=9411
      - COLLECTOR_GRPC_PORT=14250
      - COLLECTOR_HTTP_PORT=14268
      - COLLECTOR_OTLP_ENABLED=true
      - COLLECTOR_QUEUE_SIZE=2000
      - COLLECTOR_NUM_WORKERS=10
    ports:
      - "14268:14268"  # HTTP API
      - "14250:14250"  # gRPC API
      - "9411:9411"    # Zipkin API
    networks:
      - observability
    depends_on:
      elasticsearch-main:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:14268/ || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # Jaeger Query - Query and UI for traces
  jaeger-query:
    image: jaegertracing/jaeger:latest
    container_name: jaeger-query
    restart: unless-stopped
    command: jaeger-query
    environment:
      - SPAN_STORAGE_TYPE=elasticsearch
      - ES_SERVER_URLS=http://elasticsearch-main:9200
      - ES_INDEX_PREFIX=jaeger
      - QUERY_BASE_PATH=/jaeger
      - QUERY_PORT=16686
    ports:
      - "16686:16686"  # Jaeger UI
    networks:
      - observability
    depends_on:
      - elasticsearch-main
    healthcheck:
      test: curl -f http://localhost:16686/ || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # ============ APPLICATION PERFORMANCE MONITORING ============

  # Elastic APM Server - Receives and processes APM data
  apm-server:
    image: docker.elastic.co/apm/apm-server:8.11.0
    container_name: apm-server
    restart: unless-stopped
    command: apm-server -e -E apm-server.rum.enabled=true
    environment:
      - output.elasticsearch.hosts=http://elasticsearch-main:9200
      - apm-server.auth.anonymous.enabled=true
      - apm-server.auth.anonymous.allow_agent=[RUM,JS]
      - logging.level=info
      - max_content_length=262144000
      - read_timeout=3600s
      - shutdown_timeout=30s
      - mmap.enabled=true
    ports:
      - "8200:8200"    # APM Server intake API
      - "8201:8201"    # APM Server metrics
    networks:
      - observability
    depends_on:
      elasticsearch-main:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8200/ || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
    volumes:
      - ./monitoring/apm/apm-server.yml:/usr/share/apm-server/apm-server.yml:ro

  # ============ METRICS & VISUALIZATION LAYER ============

  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/alert.rules.yml:/etc/prometheus/alert.rules.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - observability
    healthcheck:
      test: curl -s http://localhost:9090/-/healthy || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # Grafana - Dashboard visualization
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-piechart-panel,redis-datasource
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_ALERTING_ENABLED=true
      - GF_UNIFIED_ALERTING_ENABLED=true
      - GF_SECURITY_COOKIE_HTTPONLY=true
      - GF_SECURITY_COOKIE_SECURE=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "3000:3000"
    networks:
      - observability
    depends_on:
      - prometheus
    healthcheck:
      test: curl -f http://localhost:3000/api/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 5

  # Alertmanager - Alert routing and notification
  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    volumes:
      - ./monitoring/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    ports:
      - "9093:9093"
    networks:
      - observability
    healthcheck:
      test: curl -s http://localhost:9093/-/healthy || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # ============ KIBANA ============

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: kibana
    restart: unless-stopped
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch-main:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=changeme
      - KIBANA_DEFAULTAPPID=discover
      - SERVER_NAME=kibana
      - XPACK_SECURITY_ENABLED=false
      - XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY=aaaaaaaaaaaaaaaabbbbbbbbbbbbbbbb
    volumes:
      - ./monitoring/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
      - ./monitoring/kibana/dashboards:/usr/share/kibana/dashboards:ro
      - kibana-data:/usr/share/kibana/data
    ports:
      - "5601:5601"
    networks:
      - observability
    depends_on:
      elasticsearch-main:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:5601/api/status || exit 1
      interval: 30s
      timeout: 10s
      retries: 5

  # ============ INFRASTRUCTURE MONITORING ============

  # Prometheus Node Exporter - System metrics
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    ports:
      - "9100:9100"
    networks:
      - observability
    pid: host

  # cAdvisor - Container metrics
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    restart: unless-stopped
    privileged: true
    devices:
      - /dev/kmsg
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    ports:
      - "8080:8080"
    networks:
      - observability

  # Elasticsearch Exporter - Elasticsearch health metrics
  elasticsearch-exporter:
    image: prometheuscommunity/elasticsearch-exporter:latest
    container_name: elasticsearch-exporter
    restart: unless-stopped
    command:
      - '--es.uri=http://elasticsearch-main:9200'
      - '--es.all'
      - '--es.indices'
      - '--es.indices_settings'
      - '--es.shards'
    ports:
      - "9114:9114"
    networks:
      - observability
    depends_on:
      - elasticsearch-main

  # Logstash Exporter - Logstash performance metrics
  logstash-exporter:
    image: prometheuscommunity/logstash-exporter:latest
    container_name: logstash-exporter
    restart: unless-stopped
    environment:
      - LOGSTASH_URL=http://logstash:9600
    ports:
      - "9304:9304"
    networks:
      - observability
    depends_on:
      - logstash

  # ============ APPLICATION INSTRUMENTATION ============

  # Sample application with full instrumentation
  sample-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sample-app
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - LOGS_HOST=logstash
      - LOGS_PORT=5000
      - TRACES_AGENT_HOST=jaeger-agent
      - TRACES_AGENT_PORT=6831
      - APM_SERVER_URL=http://apm-server:8200
      - APM_SERVICE_NAME=ai-agent-platform
      - ELASTIC_APM_ENVIRONMENT=production
      - ELASTIC_APM_LOG_LEVEL=info
      - ELASTICSEARCH_HOSTS=http://elasticsearch-main:9200
      - PROMETHEUS_PUSHGATEWAY=http://prometheus:9091
    ports:
      - "8000:8000"    # App port
      - "9090:9090"    # Metrics port
      - "3001:3001"    # Health check port
    networks:
      - observability
    depends_on:
      - elasticsearch-main
      - logstash
      - jaeger-collector
      - apm-server
    labels:
      - "prometheus.io/scrape=true"
      - "prometheus.io/port=9090"
      - "prometheus.io/path=/metrics"
    healthcheck:
      test: curl -f http://localhost:3001/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # ============ CONFIGURATION MANAGEMENT ============

  # ILM and Template Configurator
  es-configurator:
    image: curlimages/curl:latest
    container_name: es-configurator
    restart: "no"
    networks:
      - observability
    depends_on:
      elasticsearch-main:
        condition: service_healthy
    command: >
      sh -c '
      sleep 30 &&
      echo "Setting up Elasticsearch configurations..." &&
      curl -X PUT "http://elasticsearch-main:9200/_index_template/logs-default" \
        -H "Content-Type: application/json" \
        -d "{
          \"index_patterns\": [\"logs-*\"],
          \"settings\": {
            \"number_of_shards\": 3,
            \"number_of_replicas\": 1,
            \"index.lifecycle.name\": \"logs-policy\",
            \"index.lifecycle.rollover_alias\": \"logs-write\",
            \"index.codec\": \"best_compression\"
          },
          \"mappings\": {
            \"properties\": {
              \"@timestamp\": {\"type\": \"date\"},
              \"message\": {\"type\": \"text\"},
              \"level\": {\"type\": \"keyword\"},
              \"service\": {\"type\": \"keyword\"},
              \"trace_id\": {\"type\": \"keyword\"},
              \"request_id\": {\"type\": \"keyword\"},
              \"duration_ms\": {\"type\": \"long\"},
              \"user_id\": {\"type\": \"keyword\"}
            }
          }
        }" || true &&
      echo "Elasticsearch configured"
      '

networks:
  observability:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/16

volumes:
  elasticsearch-main-data:
    driver: local
  logstash-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  alertmanager-data:
    driver: local
  kibana-data:
    driver: local
