# Alert Rules for AI Agent RabbitMQ Platform
# Production-grade alert definitions

groups:
  # Critical Alerts (P1) - Immediate action required
  - name: critical_alerts
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: |
          (sum(rate(errors_total[5m])) / sum(rate(http_requests_total[5m]))) > 0.01
        for: 5m
        labels:
          severity: critical
          team: backend
          component: application
        annotations:
          summary: "High error rate detected ({{ $value | humanizePercentage }})"
          description: "Error rate is above 1% for 5 minutes. Current rate: {{ $value | humanizePercentage }}"
          runbook_url: "https://docs.example.com/runbooks/high-error-rate"
          dashboard_url: "https://grafana.example.com/d/error-dashboard"

      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          team: ops
          component: infrastructure
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "Service {{ $labels.instance }} has been down for more than 1 minute"
          runbook_url: "https://docs.example.com/runbooks/service-down"

      - alert: DatabaseConnectionPoolExhausted
        expr: |
          (connection_pool_active / connection_pool_size) > 0.95
        for: 2m
        labels:
          severity: critical
          team: backend
          component: database
        annotations:
          summary: "Database connection pool nearly exhausted"
          description: "Connection pool usage for {{ $labels.type }} is above 95% ({{ $value | humanizePercentage }})"
          runbook_url: "https://docs.example.com/runbooks/db-pool-exhausted"

      - alert: QueueOverflow
        expr: queue_size > 10000
        for: 5m
        labels:
          severity: critical
          team: backend
          component: messaging
        annotations:
          summary: "Queue {{ $labels.queue }} overflow"
          description: "Queue {{ $labels.queue }} has {{ $value }} items (threshold: 10000)"
          runbook_url: "https://docs.example.com/runbooks/queue-overflow"

      - alert: MemoryLeakDetected
        expr: |
          rate(memory_usage_bytes{type="heap_used"}[10m]) > 10485760
        for: 10m
        labels:
          severity: critical
          team: backend
          component: application
        annotations:
          summary: "Possible memory leak detected"
          description: "Memory usage increasing by {{ $value | humanize }} bytes/second for 10 minutes"
          runbook_url: "https://docs.example.com/runbooks/memory-leak"

  # Warning Alerts (P2) - Action needed soon
  - name: warning_alerts
    interval: 60s
    rules:
      - alert: ElevatedErrorRate
        expr: |
          (sum(rate(errors_total[10m])) / sum(rate(http_requests_total[10m]))) > 0.005
        for: 10m
        labels:
          severity: warning
          team: backend
          component: application
        annotations:
          summary: "Elevated error rate ({{ $value | humanizePercentage }})"
          description: "Error rate is above 0.5% for 10 minutes. Current rate: {{ $value | humanizePercentage }}"
          runbook_url: "https://docs.example.com/runbooks/elevated-error-rate"

      - alert: HighCPUUsage
        expr: |
          (100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 80
        for: 5m
        labels:
          severity: warning
          team: ops
          component: infrastructure
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is above 80% ({{ $value | humanize }}%) for 5 minutes"
          runbook_url: "https://docs.example.com/runbooks/high-cpu"

      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          team: ops
          component: infrastructure
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is above 85% ({{ $value | humanize }}%) for 5 minutes"
          runbook_url: "https://docs.example.com/runbooks/high-memory"

      - alert: SlowResponseTime
        expr: |
          histogram_quantile(0.95, sum(rate(api_request_duration_seconds_bucket[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: warning
          team: backend
          component: api
        annotations:
          summary: "Slow API response time"
          description: "P95 response time is above 2 seconds ({{ $value | humanizeDuration }})"
          runbook_url: "https://docs.example.com/runbooks/slow-response"

      - alert: QueueBackup
        expr: queue_size > 1000
        for: 5m
        labels:
          severity: warning
          team: backend
          component: messaging
        annotations:
          summary: "Queue {{ $labels.queue }} backing up"
          description: "Queue {{ $labels.queue }} has {{ $value }} items pending"
          runbook_url: "https://docs.example.com/runbooks/queue-backup"

      - alert: DiskSpaceRunningOut
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.15
        for: 5m
        labels:
          severity: warning
          team: ops
          component: infrastructure
        annotations:
          summary: "Disk space running out on {{ $labels.instance }}"
          description: "Less than 15% disk space remaining ({{ $value | humanizePercentage }} available)"
          runbook_url: "https://docs.example.com/runbooks/disk-space"

      - alert: CertificateExpiringSoon
        expr: |
          cert_expiry_days < 30
        for: 1h
        labels:
          severity: warning
          team: ops
          component: security
        annotations:
          summary: "Certificate expiring soon"
          description: "Certificate for {{ $labels.domain }} expires in {{ $value }} days"
          runbook_url: "https://docs.example.com/runbooks/cert-expiry"

  # Info Alerts (P3) - Informational
  - name: info_alerts
    interval: 120s
    rules:
      - alert: AgentRestarted
        expr: |
          changes(active_agents[5m]) > 2
        for: 1m
        labels:
          severity: info
          team: backend
          component: agents
        annotations:
          summary: "Agent {{ $labels.type }} restarted"
          description: "Agent {{ $labels.type }} has restarted {{ $value }} times in the last 5 minutes"
          runbook_url: "https://docs.example.com/runbooks/agent-restart"

      - alert: ConfigurationChanged
        expr: |
          changes(config_version[5m]) > 0
        for: 1m
        labels:
          severity: info
          team: ops
          component: configuration
        annotations:
          summary: "Configuration changed"
          description: "Configuration version changed from {{ $labels.old_version }} to {{ $labels.new_version }}"

      - alert: BatchJobStarted
        expr: |
          increase(batch_job_started_total[1m]) > 0
        for: 1m
        labels:
          severity: info
          team: backend
          component: batch
        annotations:
          summary: "Batch job {{ $labels.job_name }} started"
          description: "Batch job {{ $labels.job_name }} has started execution"

      - alert: DeploymentCompleted
        expr: |
          increase(deployment_completed_total[1m]) > 0
        for: 1m
        labels:
          severity: info
          team: ops
          component: deployment
        annotations:
          summary: "Deployment completed"
          description: "Deployment of version {{ $labels.version }} completed successfully"

  # Business Metrics Alerts
  - name: business_alerts
    interval: 60s
    rules:
      - alert: LowUserEngagement
        expr: |
          rate(votes_cast_total[1h]) < 10
        for: 30m
        labels:
          severity: warning
          team: product
          component: business
        annotations:
          summary: "Low user engagement detected"
          description: "Voting rate is below 10 votes per hour for 30 minutes"
          dashboard_url: "https://grafana.example.com/d/business-metrics"

      - alert: AchievementSystemError
        expr: |
          rate(achievements_unlocked_total[5m]) == 0 and rate(tasks_processed_total[5m]) > 0
        for: 10m
        labels:
          severity: warning
          team: backend
          component: achievements
        annotations:
          summary: "Achievement system not processing"
          description: "No achievements unlocked despite active task processing"

      - alert: PointsSystemAnomaly
        expr: |
          abs(rate(points_earned_total[5m]) - avg_over_time(rate(points_earned_total[5m])[1h:5m])) > 2 * stddev_over_time(rate(points_earned_total[5m])[1h:5m])
        for: 5m
        labels:
          severity: warning
          team: backend
          component: points
        annotations:
          summary: "Points system anomaly detected"
          description: "Points earning rate deviates significantly from normal pattern"

  # SLA Alerts
  - name: sla_alerts
    interval: 30s
    rules:
      - alert: SLAViolation99Percentile
        expr: |
          histogram_quantile(0.99, sum(rate(api_request_duration_seconds_bucket[5m])) by (le)) > 5
        for: 5m
        labels:
          severity: critical
          team: backend
          component: sla
          sla: "99th percentile"
        annotations:
          summary: "SLA violation: P99 latency > 5s"
          description: "99th percentile latency is {{ $value | humanizeDuration }}, exceeding 5s SLA"
          runbook_url: "https://docs.example.com/runbooks/sla-violation"

      - alert: AvailabilitySLAViolation
        expr: |
          avg_over_time(up[5m]) < 0.999
        for: 5m
        labels:
          severity: critical
          team: ops
          component: sla
          sla: "availability"
        annotations:
          summary: "Availability SLA violation"
          description: "Service availability is {{ $value | humanizePercentage }}, below 99.9% SLA"
          runbook_url: "https://docs.example.com/runbooks/availability-sla"

  # Predictive Alerts (using recording rules)
  - name: predictive_alerts
    interval: 300s
    rules:
      - alert: DiskWillFillIn4Hours
        expr: |
          predict_linear(node_filesystem_avail_bytes{mountpoint="/"}[1h], 4 * 3600) < 0
        for: 5m
        labels:
          severity: warning
          team: ops
          component: infrastructure
          predictive: "true"
        annotations:
          summary: "Disk will fill in ~4 hours"
          description: "At current rate, disk {{ $labels.device }} will be full in approximately 4 hours"
          runbook_url: "https://docs.example.com/runbooks/disk-filling"

      - alert: MemoryExhaustionPredicted
        expr: |
          predict_linear(memory_usage_bytes{type="heap_used"}[30m], 3600) > node_memory_MemTotal_bytes * 0.95
        for: 5m
        labels:
          severity: warning
          team: backend
          component: application
          predictive: "true"
        annotations:
          summary: "Memory exhaustion predicted within 1 hour"
          description: "At current growth rate, memory will be exhausted in approximately 1 hour"
          runbook_url: "https://docs.example.com/runbooks/memory-exhaustion"